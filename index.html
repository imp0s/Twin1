<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Persona Trainer PWA</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icon.svg" type="image/svg+xml">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<meta name="theme-color" content="#ffffff" />
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;line-height:1.4}
.screen{display:none;padding:10px}
.screen.active{display:block}
#history{max-height:60vh;overflow-y:auto;padding:6px;margin-bottom:8px;border:1px solid #ccc;border-radius:8px;background:#f8f9fa}
.chat-row{display:flex;margin-bottom:8px}
.chat-bubble{padding:8px 12px;max-width:80%;border-radius:18px}
.chat-bubble.user{margin-left:auto;background:#0b93f6;color:#fff;border-bottom-right-radius:4px}
.chat-bubble.bot{margin-right:auto;background:#e5e5ea;border-bottom-left-radius:4px}
#inputArea{display:flex;gap:8px;align-items:flex-end}
#inputArea textarea{flex:1}
#chatInput{border-radius:20px;resize:none;overflow:hidden}
.answer{cursor:pointer}
.answer.persona{border-color:#0a0;background:#e0ffe0}
pre{background:#f9f9f9;padding:8px;border:1px solid #eee;border-radius:6px;white-space:pre-wrap}
</style>
</head>
<body>
<nav class="nav nav-pills nav-fill sticky-top bg-light p-2" id="tabs">
<button class="nav-link active" data-target="main">Chat</button>
<button class="nav-link" data-target="learn">Learn</button>
</nav>
<section id="main" class="screen active container my-3">
<h2>Chat</h2>
<div id="history"></div>
<div id="samples" class="mb-2">
<button class="sample btn btn-outline-secondary btn-sm me-1 mb-1">Should I buy a house?</button>
<button class="sample btn btn-outline-secondary btn-sm me-1 mb-1">Am I ready for a long term relationship?</button>
<button class="sample btn btn-outline-secondary btn-sm mb-1">Should I change careers?</button>
</div>
<div id="inputArea" class="mb-2">
  <textarea id="chatInput" rows="1" class="form-control" placeholder="Ask something..."></textarea>
  <button id="send" class="btn btn-primary">Send</button>
</div>
<button id="clearChat" class="btn btn-secondary">Clear</button>
<button id="newPersona" class="btn btn-danger ms-2">New Persona</button>
</section>
<section id="learn" class="screen container my-3">
<h2>Learning</h2>
<div id="confidence" class="mb-2"></div>
<div id="qtext">Loading...</div>
<div id="answers" class="list-group"></div>
</section>
<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js');}
let personaId=localStorage.getItem('persona_id');
if(!personaId){personaId=crypto.randomUUID();localStorage.setItem('persona_id',personaId);}
async function ensurePersona(){await fetch('/api/init',{method:'POST',headers:{Authorization:'Bearer '+personaId}});}
ensurePersona();
let chatHistory=[];
const chatInput=document.getElementById('chatInput');
const historyDiv=document.getElementById('history');
chatInput.addEventListener('input',()=>{chatInput.style.height='auto';chatInput.style.height=chatInput.scrollHeight+'px';});
function renderChat(){historyDiv.innerHTML='';chatHistory.forEach(m=>{const row=document.createElement('div');row.className='chat-row';const bubble=document.createElement('div');bubble.className='chat-bubble '+(m.role==='user'?'user':'bot');bubble.textContent=m.content;row.appendChild(bubble);historyDiv.appendChild(row);});historyDiv.scrollTop=historyDiv.scrollHeight;}
async function serverChat(messages){const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+personaId},body:JSON.stringify({messages})});const j=await r.json();return (j.choices||[]).map(c=>c.message?.content).filter(Boolean);}
async function sendChat(){const q=chatInput.value.trim();if(!q)return;chatHistory.push({role:'user',content:q});renderChat();chatInput.value='';chatInput.style.height='auto';try{const recent=chatHistory.slice(-20);const [out]=await serverChat(recent);chatHistory.push({role:'assistant',content:out.trim()});renderChat();}catch(e){chatHistory.push({role:'assistant',content:'Error'});renderChat();}}
document.getElementById('send').onclick=sendChat;document.getElementById('clearChat').onclick=()=>{chatHistory=[];renderChat();};document.querySelectorAll('.sample').forEach(b=>b.onclick=()=>{chatInput.value=b.textContent;sendChat();});
let currentQA=null;let started=false;
async function fetchQuestion(selected){try{const opts={headers:{Authorization:'Bearer '+personaId}};if(selected==null){opts.method='GET';}else{opts.method='POST';opts.headers['Content-Type']='application/json';opts.body=JSON.stringify({selected});}
const r=await fetch('/api/learn',opts);const j=await r.json();currentQA=j;document.getElementById('qtext').textContent=j.question;const answersDiv=document.getElementById('answers');answersDiv.innerHTML='';j.answers.forEach((ans,i)=>{const d=document.createElement('div');d.textContent=ans;d.className='list-group-item list-group-item-action answer'+(i===j.personaIndex?' persona':'');d.onclick=()=>fetchQuestion(i);answersDiv.appendChild(d);});const confDiv=document.getElementById('confidence');confDiv.textContent='Confidence: '+j.confidence;confDiv.style.color=j.confidence==='high'?'green':j.confidence==='medium'?'orange':'red';started=true;}catch(e){document.getElementById('qtext').textContent='Error';}}
document.querySelectorAll('#tabs .nav-link').forEach(btn=>{btn.onclick=()=>showScreen(btn.dataset.target);});
let currentScreen='main';
function showScreen(id){currentScreen=id;document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');document.querySelectorAll('#tabs .nav-link').forEach(b=>b.classList.remove('active'));document.querySelector(`#tabs [data-target="${id}"]`).classList.add('active');if(id==='learn'&&!started)fetchQuestion();}
document.getElementById('newPersona').onclick=()=>{localStorage.clear();location.reload();};
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

