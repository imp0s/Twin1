<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Persona Trainer PWA</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icon.svg" type="image/svg+xml">
<meta name="theme-color" content="#ffffff" />
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:20px;line-height:1.4}
section{margin-bottom:24px}
button{padding:6px 12px;margin:4px;border-radius:6px;border:1px solid #888;background:#fff;cursor:pointer}
.answer{display:block;margin:6px 0;padding:8px;border:1px solid #ccc;border-radius:8px;cursor:pointer}
.answer.persona{border-color:#0a0;background:#e0ffe0}
pre{background:#f9f9f9;padding:8px;border:1px solid #eee;border-radius:6px;white-space:pre-wrap}
</style>
</head>
<body>
<h1>Persona Trainer</h1>
<section>
<label>Groq API key <input id="apikey" style="width:260px"></label>
<button id="saveKey">Save</button>
<button id="clearStorage">Clear Storage</button>
</section>
<section>
<h2>Guidance</h2>
<textarea id="guidance" rows="3" style="width:100%"></textarea><br>
<button id="addGuidance">Add guidance</button>
</section>
<section>
<h2>Persona</h2>
<pre id="persona"></pre>
</section>
<section>
<h2>Calibration</h2>
<div id="qtext">Enter an API key to begin.</div>
<div id="answers"></div>
</section>
<section>
<h2>Test persona</h2>
<textarea id="testq" rows="2" style="width:100%" placeholder="Ask something..."></textarea><br>
<button id="ask">Ask</button>
<pre id="testa"></pre>
</section>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
const persona={text:localStorage.getItem('persona')||'You are a helpful assistant.'};
const apiKeyInput=document.getElementById('apikey');
apiKeyInput.value=localStorage.getItem('groq_key')||'';
function saveKey(){localStorage.setItem('groq_key',apiKeyInput.value.trim());}
document.getElementById('saveKey').onclick=()=>{saveKey();if(!started)nextQuestion();};
document.getElementById('clearStorage').onclick=()=>{localStorage.clear();location.reload();};
const personaPre=document.getElementById('persona');
function updatePersona(){personaPre.textContent=persona.text;localStorage.setItem('persona',persona.text);}updatePersona();
document.getElementById('addGuidance').onclick=()=>{const g=document.getElementById('guidance').value.trim();if(!g)return;persona.text+='\n'+g;document.getElementById('guidance').value='';updatePersona();};
let currentQA=null;let started=false;
async function groqChat(messages){
  const key=localStorage.getItem('groq_key');
  if(!key) throw new Error('Missing API key');
  const r=await fetch('https://api.groq.com/openai/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model:'llama-3.1-8b-instant',temperature:0.7,messages})});
  const t=await r.text();
  if(!r.ok) throw new Error(t);
  const j=JSON.parse(t);
  return j.choices.map(c=>c.message.content);
}
async function nextQuestion(){
  try{
    started=true;
    const prompt=`Persona:\n${persona.text}\n\nGenerate one multiple-choice question to refine this persona. Use varied everyday topics. Return JSON {question:string, answers:string[], personaIndex:number} where personaIndex is which answer the persona would pick.`;
    const [out]=await groqChat([{role:'user',content:prompt}]);
    const qa=JSON.parse(out);
    currentQA=qa;
    document.getElementById('qtext').textContent=qa.question;
    const answersDiv=document.getElementById('answers');
    answersDiv.innerHTML='';
    qa.answers.forEach((ans,i)=>{
      const d=document.createElement('div');
      d.textContent=ans;
      d.className='answer'+(i===qa.personaIndex?' persona':'');
      d.onclick=()=>selectAnswer(i);
      answersDiv.appendChild(d);
    });
  }catch(e){
    document.getElementById('qtext').textContent=e.message;
  }
}
async function selectAnswer(idx){
  const qa=currentQA;
  const ans=qa.answers[idx];
  try{
    const prompt=`Persona:\n${persona.text}\nQuestion:${qa.question}\nAnswers:${qa.answers.join(' | ')}\nUser selected:${ans}. Update the persona description so it would choose this option. Reply with revised persona text only.`;
    const [out]=await groqChat([{role:'user',content:prompt}]);
    persona.text=out.trim();
    updatePersona();
  }catch(e){console.error(e);}
  nextQuestion();
}
document.getElementById('ask').onclick=async()=>{
  const q=document.getElementById('testq').value.trim();
  if(!q)return;
  document.getElementById('testa').textContent='...';
  try{
    const msgs=[{role:'system',content:persona.text},{role:'user',content:q}];
    const [out]=await groqChat(msgs);
    document.getElementById('testa').textContent=out.trim();
  }catch(e){
    document.getElementById('testa').textContent=e.message;
  }
};
if(localStorage.getItem('groq_key')) nextQuestion();
</script>
</body>
</html>
