<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Persona Trainer PWA</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icon.svg" type="image/svg+xml">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<meta name="theme-color" content="#ffffff" />
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;line-height:1.4}
.screen{display:none;padding:10px}
.screen.active{display:block}
#history{max-height:60vh;overflow-y:auto;padding:6px;margin-bottom:8px;border:1px solid #ccc;border-radius:8px;background:#f8f9fa}
.chat-row{display:flex;margin-bottom:8px}
.chat-bubble{padding:8px 12px;max-width:80%;border-radius:18px}
.chat-bubble.user{margin-left:auto;background:#0b93f6;color:#fff;border-bottom-right-radius:4px}
.chat-bubble.bot{margin-right:auto;background:#e5e5ea;border-bottom-left-radius:4px}
#inputArea{display:flex;gap:8px;align-items:flex-end}
#inputArea textarea{flex:1}
#chatInput{border-radius:20px;resize:none;overflow:hidden}
.answer{cursor:pointer}
.answer.persona{border-color:#0a0;background:#e0ffe0}
pre{background:#f9f9f9;padding:8px;border:1px solid #eee;border-radius:6px;white-space:pre-wrap}
</style>
</head>
<body>
<nav class="nav nav-pills nav-fill sticky-top bg-light p-2" id="tabs">
<button class="nav-link active" data-target="main">Chat</button>
<button class="nav-link" data-target="learn">Learn</button>
<button class="nav-link" data-target="persona">Persona</button>
</nav>
<section id="main" class="screen active container my-3">
<h2>Chat</h2>
<div id="history"></div>
<div id="samples" class="mb-2">
<button class="sample btn btn-outline-secondary btn-sm me-1 mb-1">Should I buy a house?</button>
<button class="sample btn btn-outline-secondary btn-sm me-1 mb-1">Am I ready for a long term relationship?</button>
<button class="sample btn btn-outline-secondary btn-sm mb-1">Should I change careers?</button>
</div>
<div id="inputArea" class="mb-2">
  <textarea id="chatInput" rows="1" class="form-control" placeholder="Ask something..."></textarea>
  <button id="send" class="btn btn-primary">Send</button>
</div>
<button id="clearChat" class="btn btn-secondary">Clear</button>
</section>
<section id="learn" class="screen container my-3">
<h2>Learning</h2>
<div id="confidence" class="mb-2"></div>
<div id="qtext">Loading...</div>
<div id="answers" class="list-group"></div>
</section>
<section id="persona" class="screen container my-3">
<h2>Persona</h2>
<input id="nameBox" class="form-control mb-2" placeholder="Persona name">
<button id="updateName" class="btn btn-secondary mb-2">Update Name</button>
<pre id="personaPreview"></pre>
<textarea id="guidanceBox" rows="3" class="form-control mb-2"></textarea>
<button id="updateGuidance" class="btn btn-primary mb-2">Update Guidance</button>
<div>
<button id="savePersona" class="btn btn-secondary me-2">Save</button>
<button id="loadPersona" class="btn btn-secondary me-2">Load</button>
<input type="file" id="loadInput" style="display:none">
<button id="clearPersona" class="btn btn-danger">Clear</button>
</div>
</section>
<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js');}
const defaultPersona='You are the digital twin of a real person who is ruthlessly asexual and devoid of gender or racial attributes.';
function optimizePersonaText(text){
  const sentences=text.split(/[\.\n]+/).map(s=>s.trim()).filter(Boolean);
  const unique=[...new Set(sentences)];
  return unique.map(s=>s.replace(/\s+/g,' ')).join('. ')+'.';
}
let personaId=localStorage.getItem('persona_id');
if(!personaId){personaId=crypto.randomUUID();localStorage.setItem('persona_id',personaId);}
let personaName=localStorage.getItem('persona_name')||'';
let persona={text:defaultPersona};
let guidanceText='';
async function initName(){
  if(!personaName){
    const r=await fetch('/api/init',{method:'POST',headers:{Authorization:'Bearer '+personaId}});
    if(r.ok){const j=await r.json();personaName=j.name;localStorage.setItem('persona_name',personaName);}
  }
  document.getElementById('nameBox').value=personaName;
}
async function loadProfile(){
  const r=await fetch('/api/profile',{headers:{Authorization:'Bearer '+personaId}});
  if(r.ok){const j=await r.json();persona.text=j.persona||defaultPersona;guidanceText=j.guidance||'';personaName=j.name||personaName;renderPersona();}
}
function renderPersona(){
  const lines=persona.text.split('\n').slice(0,3).join('\n');
  document.getElementById('personaPreview').textContent=lines+(persona.text.includes('\n')?'\n...':'')+(guidanceText?'\n'+guidanceText:'');
  document.getElementById('guidanceBox').value=guidanceText;
  document.getElementById('nameBox').value=personaName;
}
initName();
loadProfile();
document.getElementById('updateGuidance').onclick=async()=>{
  guidanceText=document.getElementById('guidanceBox').value.trim();
  await fetch('/api/guidance',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+personaId},body:JSON.stringify({guidance:guidanceText})});
  renderPersona();
};
document.getElementById('updateName').onclick=async()=>{
  const nm=document.getElementById('nameBox').value.trim();
  await fetch('/api/name',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+personaId},body:JSON.stringify({name:nm})});
  personaName=nm;localStorage.setItem('persona_name',personaName);
};
document.getElementById('savePersona').onclick=()=>{
  const data=JSON.stringify({persona:persona.text,guidance:guidanceText},null,2);
  const blob=new Blob([data],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='persona.json';a.click();URL.revokeObjectURL(a.href);
};
document.getElementById('loadPersona').onclick=()=>document.getElementById('loadInput').click();
document.getElementById('loadInput').onchange=e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=async ev=>{try{const obj=JSON.parse(ev.target.result);persona.text=optimizePersonaText(obj.persona||defaultPersona);guidanceText=obj.guidance||'';await fetch('/api/persona',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+personaId},body:JSON.stringify({persona:persona.text,guidance:guidanceText})});renderPersona();}catch(err){console.error(err);}};reader.readAsText(file);};
document.getElementById('clearPersona').onclick=async()=>{persona.text=defaultPersona;guidanceText='';await fetch('/api/persona',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+personaId},body:JSON.stringify({persona:persona.text,guidance:guidanceText})});renderPersona();};
let chatHistory=[];
const chatInput=document.getElementById('chatInput');
const historyDiv=document.getElementById('history');
chatInput.addEventListener('input',()=>{chatInput.style.height='auto';chatInput.style.height=chatInput.scrollHeight+'px';});
function renderChat(){historyDiv.innerHTML='';chatHistory.forEach(m=>{const row=document.createElement('div');row.className='chat-row';const bubble=document.createElement('div');bubble.className='chat-bubble '+(m.role==='user'?'user':'bot');bubble.textContent=m.content;row.appendChild(bubble);historyDiv.appendChild(row);});historyDiv.scrollTop=historyDiv.scrollHeight;}
async function serverChat(messages){const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+personaId},body:JSON.stringify({messages})});const j=await r.json();return (j.choices||[]).map(c=>c.message?.content).filter(Boolean);}
async function sendChat(){const q=chatInput.value.trim();if(!q)return;chatHistory.push({role:'user',content:q});renderChat();chatInput.value='';chatInput.style.height='auto';try{const recent=chatHistory.slice(-20);const [out]=await serverChat(recent);chatHistory.push({role:'assistant',content:out.trim()});renderChat();}catch(e){chatHistory.push({role:'assistant',content:'Error'});renderChat();}}
document.getElementById('send').onclick=sendChat;document.getElementById('clearChat').onclick=()=>{chatHistory=[];renderChat();};document.querySelectorAll('.sample').forEach(b=>b.onclick=()=>{chatInput.value=b.textContent;sendChat();});
let currentQA=null;let started=false;
async function fetchQuestion(selected){try{const opts={headers:{Authorization:'Bearer '+personaId}};if(selected==null){opts.method='GET';}else{opts.method='POST';opts.headers['Content-Type']='application/json';opts.body=JSON.stringify({selected});}
const r=await fetch('/api/learn',opts);const j=await r.json();currentQA=j;document.getElementById('qtext').textContent=j.question;const answersDiv=document.getElementById('answers');answersDiv.innerHTML='';j.answers.forEach((ans,i)=>{const d=document.createElement('div');d.textContent=ans;d.className='list-group-item list-group-item-action answer'+(i===j.personaIndex?' persona':'');d.onclick=()=>fetchQuestion(i);answersDiv.appendChild(d);});const confDiv=document.getElementById('confidence');confDiv.textContent='Confidence: '+j.confidence;confDiv.style.color=j.confidence==='high'?'green':j.confidence==='medium'?'orange':'red';persona.text=j.persona;renderPersona();started=true;}catch(e){document.getElementById('qtext').textContent='Error';}}
document.querySelectorAll('#tabs .nav-link').forEach(btn=>{btn.onclick=()=>showScreen(btn.dataset.target);});
let currentScreen='main';
function showScreen(id){currentScreen=id;document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');document.querySelectorAll('#tabs .nav-link').forEach(b=>b.classList.remove('active'));document.querySelector(`#tabs [data-target="${id}"]`).classList.add('active');if(id==='learn'&&!started)fetchQuestion();}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

