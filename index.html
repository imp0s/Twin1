<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Persona Trainer PWA</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icon.svg" type="image/svg+xml">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<meta name="theme-color" content="#ffffff" />
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;line-height:1.4}
.screen{display:none;padding:10px}
.screen.active{display:block}
#history{max-height:60vh;overflow-y:auto;padding:6px;margin-bottom:8px;border:1px solid #ccc;border-radius:8px;background:#f8f9fa}
.chat-row{display:flex;margin-bottom:8px}
.chat-bubble{padding:8px 12px;max-width:80%;border-radius:18px}
.chat-bubble.user{margin-left:auto;background:#0b93f6;color:#fff;border-bottom-right-radius:4px}
.chat-bubble.bot{margin-right:auto;background:#e5e5ea;border-bottom-left-radius:4px}
#inputArea{display:flex;gap:8px;align-items:flex-end}
#inputArea textarea{flex:1}
#chatInput{border-radius:20px;resize:none;overflow:hidden}
.answer{cursor:pointer}
.answer.persona{border-color:#0a0;background:#e0ffe0}
.progress-container{width:100%;height:10px;background:#ddd;border-radius:5px;margin:8px 0}
.progress-bar{height:100%;width:0%;background:red;border-radius:5px}
pre{background:#f9f9f9;padding:8px;border:1px solid #eee;border-radius:6px;white-space:pre-wrap}
</style>
</head>
<body>
<nav class="nav nav-pills nav-fill sticky-top bg-light p-2" id="tabs">
<button class="nav-link active" data-target="main">Chat</button>
<button class="nav-link" data-target="learn">Learn</button>
<button class="nav-link" data-target="persona">Persona</button>
<button class="nav-link" data-target="settings">Settings</button>
</nav>
<section id="main" class="screen active container my-3">
<h2>Chat</h2>
<div id="history"></div>
<div id="samples" class="mb-2">
<button class="sample btn btn-outline-secondary btn-sm me-1 mb-1">Should I buy a house?</button>
<button class="sample btn btn-outline-secondary btn-sm me-1 mb-1">Am I ready for a long term relationship?</button>
<button class="sample btn btn-outline-secondary btn-sm mb-1">Should I change careers?</button>
</div>
<div id="inputArea" class="mb-2">
  <textarea id="chatInput" rows="1" class="form-control" placeholder="Ask something..."></textarea>
  <button id="send" class="btn btn-primary">Send</button>
</div>
<button id="clearChat" class="btn btn-secondary">Clear</button>
</section>
<section id="learn" class="screen container my-3">
<h2>Learning</h2>
<div class="progress-container"><div id="progress" class="progress-bar"></div></div>
<div id="progressText">0%</div>
<div id="qtext">Enter an API key to begin.</div>
<div id="answers" class="list-group"></div>
</section>
<section id="persona" class="screen container my-3">
<h2>Persona</h2>
<pre id="personaPreview"></pre>
<textarea id="guidanceBox" rows="3" class="form-control mb-2"></textarea>
<button id="updateGuidance" class="btn btn-primary mb-2">Update Guidance</button>
<div>
<button id="savePersona" class="btn btn-secondary me-2">Save</button>
<button id="loadPersona" class="btn btn-secondary me-2">Load</button>
<input type="file" id="loadInput" style="display:none">
<button id="clearPersona" class="btn btn-danger">Clear</button>
</div>
</section>
<section id="settings" class="screen container my-3">
<h2>Settings</h2>
<div class="mb-2"><label class="form-label">API key <input id="apikey" class="form-control"></label></div>
<div class="mb-2"><label class="form-label">Service URL <input id="service" class="form-control"></label></div>
<button id="saveSettings" class="btn btn-primary me-2">Save</button>
<button id="clearStorage" class="btn btn-secondary me-2">Clear Storage</button>
<button id="refresh" class="btn btn-warning">Refresh</button>
</section>
<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js');}
const defaultPersona='You are the digital twin of a real person who is ruthlessly asexual and devoid of gender or racial attributes.';
function optimizePersonaText(text){
  const sentences=text.split(/[\.\n]+/).map(s=>s.trim()).filter(Boolean);
  const unique=[...new Set(sentences)];
  return unique.map(s=>s.replace(/\s+/g,' ')).join('. ')+'.';
}
let persona={text:optimizePersonaText(localStorage.getItem('persona')||defaultPersona)};
let guidanceText=localStorage.getItem('guidance')||'';
let coverage=JSON.parse(localStorage.getItem('coverage')||'{}');
let chatHistory=[];
const apiKeyInput=document.getElementById('apikey');
const serviceInput=document.getElementById('service');
apiKeyInput.value=localStorage.getItem('api_key')||localStorage.getItem('groq_key')||'';
serviceInput.value=localStorage.getItem('service')||'https://api.groq.com/openai/v1/chat/completions';
function saveSettings(){localStorage.setItem('api_key',apiKeyInput.value.trim());localStorage.setItem('service',serviceInput.value.trim());}
document.getElementById('saveSettings').onclick=()=>{saveSettings();if(!started&&currentScreen==='learn')nextQuestion();};
document.getElementById('clearStorage').onclick=()=>{localStorage.clear();location.reload();};
document.getElementById('refresh').onclick=async()=>{if('serviceWorker' in navigator){const regs=await navigator.serviceWorker.getRegistrations();for(const r of regs)await r.unregister();}const keys=await caches.keys();await Promise.all(keys.map(k=>caches.delete(k)));location.reload();};
function renderPersona(){const lines=persona.text.split('\n').slice(0,3).join('\n');document.getElementById('personaPreview').textContent=lines+(persona.text.includes('\n')?'\n...':'')+(guidanceText?'\n'+guidanceText:'');document.getElementById('guidanceBox').value=guidanceText;}
function storePersona(){localStorage.setItem('persona',persona.text);localStorage.setItem('guidance',guidanceText);}
function updatePersona(){storePersona();renderPersona();updateProgress();}
renderPersona();
document.getElementById('updateGuidance').onclick=()=>{guidanceText=document.getElementById('guidanceBox').value.trim();updatePersona();};
document.getElementById('savePersona').onclick=()=>{const data=JSON.stringify({persona:persona.text,guidance:guidanceText},null,2);const blob=new Blob([data],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='persona.json';a.click();URL.revokeObjectURL(a.href);};
document.getElementById('loadPersona').onclick=()=>document.getElementById('loadInput').click();
document.getElementById('loadInput').onchange=e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=ev=>{try{const obj=JSON.parse(ev.target.result);persona.text=optimizePersonaText(obj.persona||defaultPersona);guidanceText=obj.guidance||'';coverage={};localStorage.removeItem('coverage');updatePersona();}catch(err){console.error(err);}};reader.readAsText(file);};
document.getElementById('clearPersona').onclick=()=>{persona.text=optimizePersonaText(defaultPersona);guidanceText='';coverage={};localStorage.removeItem('coverage');updatePersona();};
const categories=[
  {name:'Likes & Dislikes',desc:'tastes in activities or food'},
  {name:'Politics & Society',desc:'political and social outlook'},
  {name:'Geography & Climate',desc:'preferred places and weather'},
  {name:'Energy & Routine',desc:'daily energy and lifestyle'},
  {name:'Aspirations & Goals',desc:'career or life ambitions'},
  {name:'Psychological Traits',desc:'thinking patterns and behaviour'},
  {name:'Culture & Arts',desc:'music, media and art interests'},
  {name:'Relationships & Community',desc:'friendships and social ties'},
  {name:'Work & Productivity',desc:'discipline and work style'},
  {name:'Decision Making & Values',desc:'how choices and priorities form'},
  {name:'Emotions & Coping',desc:'responses to stress or loss'},
  {name:'Technology & Innovation',desc:'attitude toward new tech'},
  {name:'Spare Time & Hobbies',desc:'weekend and leisure pursuits'},
  {name:'Financial Outlook',desc:'saving, spending or investing'},
  {name:'Travel & Adventure',desc:'motivation for exploring new places'}
];
function leastCovered(){let min=Infinity,opts=[];categories.forEach(c=>{const v=coverage[c.name]||0;if(v<min){min=v;opts=[c];}else if(v===min){opts.push(c);}});return opts[Math.floor(Math.random()*opts.length)];}
let currentQA=null;let currentCategory=null;let started=false;const progressBar=document.getElementById('progress');const progressText=document.getElementById('progressText');
function updateProgress(){const answered=Object.values(coverage).reduce((a,b)=>a+b,0);const pct=Math.round(100*(1-Math.exp(-answered/5)));progressBar.style.width=pct+'%';progressBar.style.backgroundColor=answered<5?'red':answered<10?'orange':'green';progressText.textContent=pct+'%';}
updateProgress();
async function groqChat(messages){const key=localStorage.getItem('api_key')||localStorage.getItem('groq_key');const svc=localStorage.getItem('service')||'https://api.groq.com/openai/v1/chat/completions';if(!key) throw new Error('Missing API key');const r=await fetch(svc,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model:'llama-3.1-8b-instant',temperature:0.7,messages})});const t=await r.text();if(!r.ok) throw new Error(t);const j=JSON.parse(t);const contents=(j.choices||[]).map(c=>c.message?.content).filter(Boolean);return contents;}
function showRetry(target,action){target.innerHTML='';const b=document.createElement('button');b.textContent='Retry';b.onclick=action;target.appendChild(b);}
async function nextQuestion(){
  try{
    started=true;
    const cat=leastCovered();
    currentCategory=cat.name;
    const prompt=`Persona:\n${persona.text}\nGuidance:\n${guidanceText}\n\nGenerate one concise multiple-choice question (<=15 words) about this persona's ${cat.name} (${cat.desc}). Provide two to four brief answers (<=6 words) that are mutually exclusive and collectively exhaustive. Do not include 'not applicable' or similar options and avoid any reference to gender, sexuality or race. Only repeat a topic to clarify ambiguity. Return JSON {question:string, answers:string[], personaIndex:number}.`;
    const [out]=await groqChat([{role:'user',content:prompt}]);
    const match=out.match(/\{[\s\S]*\}/);
    if(!match) throw new Error('Model did not return JSON');
    const cleaned=match[0].replace(/\/\/.*$/gm,'').replace(/\/\*[\s\S]*?\*\//g,'');
    const qa=JSON.parse(cleaned);
    currentQA=qa;
    document.getElementById('qtext').textContent=qa.question;
    const answersDiv=document.getElementById('answers');
    answersDiv.innerHTML='';
    qa.answers.forEach((ans,i)=>{
      const d=document.createElement('div');
      d.textContent=ans;
      d.className='list-group-item list-group-item-action answer'+(i===qa.personaIndex?' persona':'');
      d.onclick=()=>selectAnswer(i);
      answersDiv.appendChild(d);
    });
  }catch(e){
    document.getElementById('qtext').textContent='';
    showRetry(document.getElementById('answers'),nextQuestion);
  }
}
async function selectAnswer(idx){const qa=currentQA;const ans=qa.answers[idx];const answersDiv=document.getElementById('answers');try{const prompt=`Existing persona:\n${persona.text}\nGuidance:\n${guidanceText}\nQuestion:${qa.question}\nCategory:${currentCategory}\nAnswers:${qa.answers.join(' | ')}\nUser selected:${ans}. Revise the persona incrementally so it leans toward this option while avoiding assumptions about name, gender, sexuality, or race. Ensure the persona remains ruthlessly asexual, concise and non-redundant. Reply with the updated persona text only.`;const [out]=await groqChat([{role:'user',content:prompt}]);persona.text=optimizePersonaText(out.trim());coverage[currentCategory]=(coverage[currentCategory]||0)+1;localStorage.setItem('coverage',JSON.stringify(coverage));updatePersona();nextQuestion();}catch(e){showRetry(answersDiv,()=>selectAnswer(idx));}}
const chatInput=document.getElementById('chatInput');const historyDiv=document.getElementById('history');
chatInput.addEventListener('input',()=>{chatInput.style.height='auto';chatInput.style.height=chatInput.scrollHeight+'px';});
function renderChat(){historyDiv.innerHTML='';chatHistory.forEach(m=>{const row=document.createElement('div');row.className='chat-row';const bubble=document.createElement('div');bubble.className='chat-bubble '+(m.role==='user'?'user':'bot');bubble.textContent=m.content;row.appendChild(bubble);historyDiv.appendChild(row);});historyDiv.scrollTop=historyDiv.scrollHeight;}
async function sendChat(){const q=chatInput.value.trim();if(!q)return;chatHistory.push({role:'user',content:q});renderChat();chatInput.value='';chatInput.style.height='auto';try{const msgs=[{role:'system',content:`You are the following persona:\n${persona.text}\nGuidance:\n${guidanceText}\nAnswer strictly as this persona while avoiding any mention of gender, sexuality or race. Be concise and give a clear, direct reply in one short sentence.`},...chatHistory];const [out]=await groqChat(msgs);chatHistory.push({role:'assistant',content:out.trim()});renderChat();}catch(e){chatHistory.push({role:'assistant',content:'Error'});renderChat();}}
document.getElementById('send').onclick=sendChat;document.getElementById('clearChat').onclick=()=>{chatHistory=[];renderChat();};document.querySelectorAll('.sample').forEach(b=>b.onclick=()=>{chatInput.value=b.textContent;sendChat();});
let currentScreen='main';
function showScreen(id){currentScreen=id;document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');document.querySelectorAll('#tabs .nav-link').forEach(b=>b.classList.remove('active'));document.querySelector(`#tabs [data-target="${id}"]`).classList.add('active');if(id==='learn'&&!started&&(localStorage.getItem('api_key')||localStorage.getItem('groq_key')))nextQuestion();}
document.querySelectorAll('#tabs .nav-link').forEach(btn=>{btn.onclick=()=>showScreen(btn.dataset.target);});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
